#' Construct a Makefile
#'
#' This function constructs a \code{Makefile} for various objects.
#'
#' @param y The object to construct the \code{Makefile} for
#' @return A Makefile
#'
#' @export
makify <- function(y) UseMethod("makify", y)

#' @export
makify.default <- function(y) {
  stop("Cannot use makify for object of class ", class(y))
}

#' @importFrom MakefileR make_rule make_def make_group make_comment
#' @export
makify.rpkgweb <- function(y) {
  make_group(make_comment("Autogenerated using rpkgweb"), sep = "") +
    make_def("R_USER_LIBRARY", .libPaths()[[1L]]) +
    make_rule("all", y$packages %>% names) +
    make_rule(".FORCE") +
    make_rule("Makefile", ".FORCE",
              "write_makefile()" %>%
                .rpkgweb_qualify() %>% Rscript_call()) +
    make_rule(lib_desc_path("%"), code_desc_path("%"),
              "check_up('$(patsubst %/,%,$(dir $<))')" %>%
                .rpkgweb_qualify() %>% Rscript_call()) +
    (
      y$packages %>%
        names %>%
        lapply(. %>% { make_rule(., lib_desc_path(.)) } ) %>%
        make_group(make_comment("Convenience targets"), .dots = .)
    ) +
    makify(y %>% deps_df)
}

#' @importFrom MakefileR make_rule
#' @export
makify.deps_df <- function(y) {
  rules <- mapply(y$package %>% lib_desc_path,
                  y$name %>% lib_desc_path,
                  FUN = make_rule, SIMPLIFY = FALSE)
  Reduce(c, rules, init = make_group(make_comment("Dependencies")))
}

lib_desc_path <- . %>% file.path("${R_USER_LIBRARY}", ., "DESCRIPTION")
code_desc_path <- . %>% file.path(., "DESCRIPTION")

.rpkgweb_qualify <- function(expr) {
  sprintf("rpkgweb::%s", expr)
}

Rscript_call <- function(expr) {
  sprintf("Rscript -e \"%s\"", expr)
}
